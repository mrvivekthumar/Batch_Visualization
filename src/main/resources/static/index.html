<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Batch Performance Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Authentication Modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .auth-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .auth-title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8rem;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .auth-button:hover {
            transform: translateY(-2px);
        }

        .auth-error {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }

        /* Header */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .user-info {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        /* Enhanced notification system */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .notification.info {
            background: linear-gradient(135deg, #17a2b8, #007bff);
        }

        /* Enhanced controls */
        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .control-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        input,
        select,
        button {
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .button-loading {
            opacity: 0.7;
        }

        .button-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Enhanced stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-trend {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .trend-up {
            color: #28a745;
        }

        .trend-down {
            color: #dc3545;
        }

        /* Enhanced charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        /* Enhanced results section */
        .results-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .results-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .result-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease;
        }

        .result-item:hover {
            transform: translateX(5px);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-type {
            font-weight: 600;
            font-size: 1.1rem;
            color: #667eea;
        }

        .result-time {
            font-size: 0.9rem;
            color: #666;
        }

        .result-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
        }

        /* Loading states */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-weight: 600;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* Error states */
        .error-message {
            background: linear-gradient(135deg, #fee 0%, #fdd 100%);
            color: #c33;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }

        .error-code {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-top: 5px;
            opacity: 0.8;
        }

        /* Rate limiting info */
        .rate-limit-info {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9rem;
            border-left: 4px solid #ffc107;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .user-info {
                position: static;
                margin-top: 20px;
                text-align: center;
            }
        }

        /* Print styles */
        @media print {

            .auth-modal,
            .notification,
            .loading,
            button,
            .user-info {
                display: none !important;
            }

            .container {
                max-width: none;
                padding: 0;
            }

            .chart-container {
                break-inside: avoid;
                margin-bottom: 20px;
            }

            body {
                background: white !important;
                color: black !important;
            }
        }

        /* Accessibility */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 3px solid #667eea !important;
            outline-offset: 2px !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Touch-friendly sizes for mobile */
        @media (max-width: 768px) {
            button {
                min-height: 44px;
                min-width: 44px;
            }

            input,
            select {
                min-height: 44px;
            }
        }

        /* Dark theme support */
        .dark-theme {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --card-bg: #2d2d2d;
            --border-color: #404040;
        }

        .dark-theme body {
            background: var(--bg-color);
            color: var(--text-color);
        }

        .dark-theme .controls,
        .dark-theme .chart-container,
        .dark-theme .results-section,
        .dark-theme .stat-card {
            background: var(--card-bg);
            color: var(--text-color);
        }
    </style>
</head>

<body>
    <!-- Authentication Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-form">
            <h2 class="auth-title">🔐 Login Required</h2>
            <div class="auth-error" id="authError"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required
                        placeholder="Enter username (admin/viewer)" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required placeholder="Enter password"
                        autocomplete="current-password">
                </div>
                <button type="submit" class="auth-button" id="loginButton">
                    Sign In
                </button>
            </form>
            <div style="margin-top: 20px; text-align: center; font-size: 0.9rem; color: #666;">
                <p><strong>Demo Credentials:</strong></p>
                <p>Admin: admin / admin123!</p>
                <p>Viewer: viewer / viewer123!</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>🚀 Database Batch Performance Analyzer</h1>
            <p>Real-time Performance Testing & Visualization Dashboard</p>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="currentUser"></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Notification Container -->
        <div id="notificationContainer"></div>

        <!-- Rate Limit Info -->
        <div class="rate-limit-info" id="rateLimitInfo" style="display: none;">
            <span id="rateLimitText"></span>
        </div>

        <!-- System Stats -->
        <div class="stats-grid" id="systemStats">
            <div class="stat-card">
                <div class="stat-value" id="cpuCount">-</div>
                <div class="stat-label">CPU Cores</div>
                <div class="stat-trend" id="cpuTrend"></div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalMemory">-</div>
                <div class="stat-label">Total Memory (MB)</div>
                <div class="stat-trend" id="memoryTrend"></div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="usedMemory">-</div>
                <div class="stat-label">Used Memory (MB)</div>
                <div class="stat-trend" id="usedMemoryTrend"></div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="dbRecords">-</div>
                <div class="stat-label">Database Records</div>
                <div class="stat-trend" id="dbTrend"></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label for="totalRecords">Total Records</label>
                    <input type="number" id="totalRecords" value="1000" min="100" max="100000"
                        aria-describedby="totalRecordsHelp">
                    <small id="totalRecordsHelp">Between 100 and 100,000 records</small>
                </div>
                <div class="control-group">
                    <label for="batchSize">Batch Size</label>
                    <select id="batchSize" aria-describedby="batchSizeHelp">
                        <option value="1">1 (One by One)</option>
                        <option value="10">10</option>
                        <option value="100" selected>100</option>
                        <option value="1000">1000</option>
                        <option value="5000">5000</option>
                    </select>
                    <small id="batchSizeHelp">Larger batches are usually faster</small>
                </div>
                <button onclick="runInsertTest()" id="insertBtn" aria-describedby="insertHelp">📝 INSERT Test</button>
                <button onclick="runDeleteTest()" id="deleteBtn" aria-describedby="deleteHelp">🗑️ DELETE Test</button>
            </div>
            <div style="margin-top: 10px;">
                <small id="insertHelp">Requires ADMIN role. Inserts test records into database.</small><br>
                <small id="deleteHelp">Requires ADMIN role. Deletes records from database.</small>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <div id="loadingText">Running performance test... Please wait.</div>
            <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                <span id="progressText"></span>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">⏱️ Execution Time Comparison</div>
                <canvas id="timeChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">📊 Records Per Second</div>
                <canvas id="throughputChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">💾 Memory Usage</div>
                <canvas id="memoryChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">🔄 Average Time Per Record</div>
                <canvas id="avgTimeChart"></canvas>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <div class="results-title">📈 Test Results</div>
            <div id="resultsContainer">
                <p style="text-align: center; color: #666; font-style: italic;">
                    Sign in and run a performance test to see detailed results here.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let charts = {};
        let testResults = [];
        let currentUser = null;
        let userRole = null;
        let authToken = null;
        let rateLimitInfo = {
            general: null,
            performance: null
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            initializeCharts();
            checkAuthentication();

            // Setup form handlers
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Setup input validation
            setupInputValidation();

            // Check for saved credentials (development only)
            const savedUsername = localStorage.getItem('demo_username');
            if (savedUsername) {
                document.getElementById('username').value = savedUsername;
            }
        });

        // ===== AUTHENTICATION =====

        async function checkAuthentication() {
            const stored = localStorage.getItem('auth_token');
            const storedUser = localStorage.getItem('current_user');
            const storedRole = localStorage.getItem('user_role');

            if (stored && storedUser && storedRole) {
                authToken = stored;
                currentUser = storedUser;
                userRole = storedRole;

                // Test the token
                try {
                    await makeAuthenticatedRequest('/api/v1/performance/health');
                    showDashboard();
                    startDataRefresh();
                } catch (error) {
                    // Token invalid, show login
                    clearAuth();
                    showLogin();
                }
            } else {
                showLogin();
            }
        }

        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');

            // Show loading state
            loginButton.classList.add('button-loading');
            loginButton.disabled = true;
            loginButton.textContent = 'Signing in...';

            hideAuthError();

            try {
                // Create credentials for basic auth
                const credentials = btoa(`${username}:${password}`);
                authToken = `Basic ${credentials}`;

                // Test authentication
                const response = await makeAuthenticatedRequest('/api/v1/performance/health');

                // Store auth info
                currentUser = username;
                userRole = username === 'admin' ? 'ADMIN' : 'VIEWER';

                localStorage.setItem('auth_token', authToken);
                localStorage.setItem('current_user', currentUser);
                localStorage.setItem('user_role', userRole);
                localStorage.setItem('demo_username', username); // For demo convenience

                showNotification(`Welcome ${currentUser}! You are logged in as ${userRole}.`, 'success');
                showDashboard();
                startDataRefresh();

            } catch (error) {
                console.error('Login failed:', error);
                showAuthError(getErrorMessage(error));
                clearAuth();
            } finally {
                // Reset button state
                loginButton.classList.remove('button-loading');
                loginButton.disabled = false;
                loginButton.textContent = 'Sign In';
            }
        }

        function logout() {
            clearAuth();
            showLogin();
            showNotification('You have been logged out successfully.', 'info');
        }

        function clearAuth() {
            authToken = null;
            currentUser = null;
            userRole = null;
            localStorage.removeItem('auth_token');
            localStorage.removeItem('current_user');
            localStorage.removeItem('user_role');

            // Stop auto-refresh
            if (window.refreshInterval) {
                clearInterval(window.refreshInterval);
            }
        }

        function showLogin() {
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('userInfo').style.display = 'none';

            // Disable all controls
            const buttons = document.querySelectorAll('button:not(.auth-button):not(.logout-btn)');
            buttons.forEach(btn => btn.disabled = true);
        }

        function showDashboard() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('currentUser').textContent = `${currentUser} (${userRole})`;

            // Enable controls based on role
            updateControlsForRole();
        }

        function updateControlsForRole() {
            const insertBtn = document.getElementById('insertBtn');
            const deleteBtn = document.getElementById('deleteBtn');

            if (userRole === 'ADMIN') {
                insertBtn.disabled = false;
                deleteBtn.disabled = false;
                insertBtn.title = 'Run INSERT performance test';
                deleteBtn.title = 'Run DELETE performance test';
            } else {
                insertBtn.disabled = true;
                deleteBtn.disabled = true;
                insertBtn.title = 'ADMIN role required for INSERT operations';
                deleteBtn.title = 'ADMIN role required for DELETE operations';
            }
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideAuthError() {
            document.getElementById('authError').style.display = 'none';
        }

        // ===== API COMMUNICATION =====

        async function makeAuthenticatedRequest(url, options = {}) {
            if (!authToken) {
                throw new Error('Not authenticated');
            }

            const config = {
                ...options,
                headers: {
                    'Authorization': authToken,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };

            const response = await axios(url, config);

            // Check for rate limiting headers
            checkRateLimitHeaders(response.headers);

            return response;
        }

        function checkRateLimitHeaders(headers) {
            const generalRemaining = headers['x-rate-limit-remaining'];
            const performanceRemaining = headers['x-rate-limit-remaining-performance'];

            if (generalRemaining !== undefined) {
                rateLimitInfo.general = parseInt(generalRemaining);
            }

            if (performanceRemaining !== undefined) {
                rateLimitInfo.performance = parseInt(performanceRemaining);
            }

            updateRateLimitDisplay();
        }

        function updateRateLimitDisplay() {
            const rateLimitDiv = document.getElementById('rateLimitInfo');
            const rateLimitText = document.getElementById('rateLimitText');

            if (rateLimitInfo.performance !== null && rateLimitInfo.performance < 5) {
                rateLimitDiv.style.display = 'block';
                rateLimitText.textContent = `⚠️ Rate limit warning: ${rateLimitInfo.performance} performance operations remaining this hour.`;
            } else if (rateLimitInfo.general !== null && rateLimitInfo.general < 10) {
                rateLimitDiv.style.display = 'block';
                rateLimitText.textContent = `⚠️ Rate limit warning: ${rateLimitInfo.general} API calls remaining this minute.`;
            } else {
                rateLimitDiv.style.display = 'none';
            }
        }

        function getErrorMessage(error) {
            if (error.response) {
                const data = error.response.data;
                if (data && data.message) {
                    return data.message;
                }

                switch (error.response.status) {
                    case 401:
                        return 'Invalid username or password. Please try again.';
                    case 403:
                        return 'Access denied. You do not have permission for this operation.';
                    case 429:
                        return 'Rate limit exceeded. Please wait before trying again.';
                    case 500:
                        return 'Server error. Please try again later.';
                    default:
                        return `Request failed with status ${error.response.status}`;
                }
            } else if (error.request) {
                return 'Network error. Please check your connection and try again.';
            } else {
                return error.message || 'An unexpected error occurred.';
            }
        }

        // ===== PERFORMANCE TESTS =====

        async function runInsertTest() {
            if (userRole !== 'ADMIN') {
                showNotification('INSERT operations require ADMIN role.', 'warning');
                return;
            }

            const totalRecords = document.getElementById('totalRecords').value;
            const batchSize = document.getElementById('batchSize').value;

            if (!validateInputs(totalRecords, batchSize)) {
                return;
            }

            showLoading(`Running INSERT test: ${totalRecords} records with batch size ${batchSize}...`);

            try {
                const response = await makeAuthenticatedRequest('/api/v1/performance/initialize', {
                    method: 'POST',
                    params: {
                        totalRecords: parseInt(totalRecords),
                        batchSize: parseInt(batchSize)
                    }
                });

                const result = response.data.data;
                testResults.push(result);
                updateCharts();
                displayResults([result]);
                loadDatabaseStats();

                const operation = batchSize == 1 ? "one by one" : `in batches of ${batchSize}`;
                showNotification(
                    `✅ INSERT completed: ${result.recordsProcessed} records ${operation} in ${result.durationMs}ms`,
                    'success'
                );

            } catch (error) {
                console.error('INSERT test failed:', error);
                showNotification(`❌ INSERT test failed: ${getErrorMessage(error)}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function runDeleteTest() {
            if (userRole !== 'ADMIN') {
                showNotification('DELETE operations require ADMIN role.', 'warning');
                return;
            }

            const totalRecords = document.getElementById('totalRecords').value;
            const batchSize = document.getElementById('batchSize').value;

            if (!validateInputs(totalRecords, batchSize)) {
                return;
            }

            showLoading(`Running DELETE test: ${totalRecords} records with batch size ${batchSize}...`);

            try {
                const response = await makeAuthenticatedRequest('/api/v1/performance/delete', {
                    method: 'POST',
                    params: {
                        totalRecords: parseInt(totalRecords),
                        batchSize: parseInt(batchSize)
                    }
                });

                const result = response.data.data;
                testResults.push(result);
                updateCharts();
                displayResults([result]);
                loadDatabaseStats();

                const operation = batchSize == 1 ? "one by one" : `in batches of ${batchSize}`;
                showNotification(
                    `✅ DELETE completed: ${result.recordsProcessed} records ${operation} in ${result.durationMs}ms`,
                    'success'
                );

            } catch (error) {
                console.error('DELETE test failed:', error);
                showNotification(`❌ DELETE test failed: ${getErrorMessage(error)}`, 'error');
            } finally {
                hideLoading();
            }
        }

        function validateInputs(totalRecords, batchSize) {
            const records = parseInt(totalRecords);
            const batch = parseInt(batchSize);

            if (records < 100 || records > 100000) {
                showNotification('Total records must be between 100 and 100,000.', 'warning');
                return false;
            }

            if (batch < 1 || batch > 10000) {
                showNotification('Batch size must be between 1 and 10,000.', 'warning');
                return false;
            }

            if (batch > records) {
                showNotification('Batch size cannot be greater than total records.', 'warning');
                return false;
            }

            return true;
        }

        // ===== DATA LOADING =====

        async function loadSystemStats() {
            try {
                const response = await makeAuthenticatedRequest('/api/v1/performance/stats/system');
                const stats = response.data.data;

                document.getElementById('cpuCount').textContent = stats.jvm.availableProcessors;
                document.getElementById('totalMemory').textContent = stats.jvm.totalMemoryMB;
                document.getElementById('usedMemory').textContent = stats.jvm.usedMemoryMB;

                // Update memory usage trend
                const memoryPercent = stats.jvm.memoryUsagePercent;
                const usedMemoryTrend = document.getElementById('usedMemoryTrend');

                if (memoryPercent > 80) {
                    usedMemoryTrend.textContent = `${memoryPercent}% (High)`;
                    usedMemoryTrend.className = 'stat-trend trend-down';
                } else if (memoryPercent > 60) {
                    usedMemoryTrend.textContent = `${memoryPercent}% (Medium)`;
                    usedMemoryTrend.className = 'stat-trend';
                } else {
                    usedMemoryTrend.textContent = `${memoryPercent}% (Good)`;
                    usedMemoryTrend.className = 'stat-trend trend-up';
                }

            } catch (error) {
                console.error('Failed to load system stats:', error);
                if (error.response?.status === 401) {
                    logout();
                }
            }
        }

        async function loadDatabaseStats() {
            try {
                const response = await makeAuthenticatedRequest('/api/v1/performance/stats/database');
                const stats = response.data.data;
                document.getElementById('dbRecords').textContent = stats.totalRecords.toLocaleString();

                // Update database trend
                const dbTrend = document.getElementById('dbTrend');
                if (stats.activeOperations > 0) {
                    dbTrend.textContent = `${stats.activeOperations} active ops`;
                    dbTrend.className = 'stat-trend';
                } else {
                    dbTrend.textContent = 'Ready';
                    dbTrend.className = 'stat-trend trend-up';
                }

            } catch (error) {
                console.error('Failed to load database stats:', error);
                document.getElementById('dbRecords').textContent = 'Error';
                if (error.response?.status === 401) {
                    logout();
                }
            }
        }

        function startDataRefresh() {
            // Initial load
            loadSystemStats();
            loadDatabaseStats();

            // Auto-refresh every 30 seconds
            // DISABLED: window.refreshInterval = setInterval(() => {
                loadSystemStats();
                loadDatabaseStats();
            }, 30000);
        }

        // ===== UI HELPERS =====

        function showLoading(message = 'Loading...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingIndicator').style.display = 'block';
            document.querySelectorAll('button').forEach(btn => {
                if (!btn.classList.contains('logout-btn')) {
                    btn.disabled = true;
                }
            });
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
            updateControlsForRole(); // Re-enable appropriate controls
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            container.appendChild(notification);

            // Trigger animation
            setTimeout(() => notification.classList.add('show'), 100);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => container.removeChild(notification), 300);
            }, 5000);
        }

        function setupInputValidation() {
            const totalRecordsInput = document.getElementById('totalRecords');
            const batchSizeSelect = document.getElementById('batchSize');

            totalRecordsInput.addEventListener('input', function () {
                const value = parseInt(this.value);
                if (value < 100) {
                    this.setCustomValidity('Minimum 100 records required');
                } else if (value > 100000) {
                    this.setCustomValidity('Maximum 100,000 records allowed');
                } else {
                    this.setCustomValidity('');
                }
            });

            // Update batch size validation based on total records
            function validateBatchSize() {
                const totalRecords = parseInt(totalRecordsInput.value);
                const batchSize = parseInt(batchSizeSelect.value);

                if (batchSize > totalRecords) {
                    batchSizeSelect.setCustomValidity('Batch size cannot exceed total records');
                } else {
                    batchSizeSelect.setCustomValidity('');
                }
            }

            totalRecordsInput.addEventListener('change', validateBatchSize);
            batchSizeSelect.addEventListener('change', validateBatchSize);
        }

        // ===== CHARTS =====

        function initializeCharts() {
            const chartConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            };

            // Time comparison chart
            charts.timeChart = new Chart(document.getElementById('timeChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Execution Time (ms)',
                        data: [],
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Time (milliseconds)'
                            }
                        }
                    }
                }
            });

            // Throughput chart
            charts.throughputChart = new Chart(document.getElementById('throughputChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Records/Second',
                        data: [],
                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 3,
                        fill: true
                    }]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Records per Second'
                            }
                        }
                    }
                }
            });

            // Memory usage chart
            charts.memoryChart = new Chart(document.getElementById('memoryChart'), {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: chartConfig
            });

            // Average time per record chart
            charts.avgTimeChart = new Chart(document.getElementById('avgTimeChart'), {
                type: 'radar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Avg Time/Record (ms)',
                        data: [],
                        backgroundColor: 'rgba(118, 75, 162, 0.2)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(118, 75, 162, 1)'
                    }]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        r: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCharts() {
            if (testResults.length === 0) return;

            // Time comparison chart
            charts.timeChart.data.labels = testResults.map(r => `${r.testType} (${r.batchSize})`);
            charts.timeChart.data.datasets[0].data = testResults.map(r => r.durationMs);
            charts.timeChart.update('active');

            // Throughput chart
            charts.throughputChart.data.labels = testResults.map(r => `Batch ${r.batchSize}`);
            charts.throughputChart.data.datasets[0].data = testResults.map(r => r.recordsPerSecond);
            charts.throughputChart.update('active');

            // Memory chart
            const memoryData = testResults.slice(-5).map(r => r.memoryUsedMB);
            const memoryLabels = testResults.slice(-5).map(r => `Batch ${r.batchSize}`);
            charts.memoryChart.data.labels = memoryLabels;
            charts.memoryChart.data.datasets[0].data = memoryData;
            charts.memoryChart.update('active');

            // Average time chart
            charts.avgTimeChart.data.labels = testResults.map(r => `Batch ${r.batchSize}`);
            charts.avgTimeChart.data.datasets[0].data = testResults.map(r => r.averageTimePerRecord);
            charts.avgTimeChart.update('active');
        }

        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            results.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-item';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'result-header';

                const typeSpan = document.createElement('span');
                typeSpan.className = 'result-type';
                typeSpan.textContent = `${result.testType.replace('_', ' ')} - Batch Size: ${result.batchSize}`;

                const timeSpan = document.createElement('span');
                timeSpan.className = 'result-time';
                timeSpan.textContent = new Date(result.endTime).toLocaleString();

                headerDiv.appendChild(typeSpan);
                headerDiv.appendChild(timeSpan);

                const metricsDiv = document.createElement('div');
                metricsDiv.className = 'result-metrics';

                const metrics = [
                    { label: 'Records Processed', value: result.recordsProcessed.toLocaleString() },
                    { label: 'Duration (ms)', value: result.durationMs.toLocaleString() },
                    { label: 'Avg Time/Record (ms)', value: result.averageTimePerRecord.toFixed(3) },
                    { label: 'Throughput (rec/sec)', value: Math.round(result.recordsPerSecond).toLocaleString() },
                    { label: 'Memory Used (MB)', value: result.memoryUsedMB },
                    { label: 'Batch Count', value: result.batchCount }
                ];

                metrics.forEach(metric => {
                    const metricDiv = document.createElement('div');
                    metricDiv.className = 'metric';

                    const valueDiv = document.createElement('div');
                    valueDiv.className = 'metric-value';
                    valueDiv.textContent = metric.value;

                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'metric-label';
                    labelDiv.textContent = metric.label;

                    metricDiv.appendChild(valueDiv);
                    metricDiv.appendChild(labelDiv);
                    metricsDiv.appendChild(metricDiv);
                });

                resultDiv.appendChild(headerDiv);
                resultDiv.appendChild(metricsDiv);
                container.appendChild(resultDiv);
            });
        }

        // ===== KEYBOARD SHORTCUTS =====

        document.addEventListener('keydown', function (event) {
            // Ctrl/Cmd + Enter to run insert test (if admin)
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                event.preventDefault();
                if (userRole === 'ADMIN' && !document.getElementById('insertBtn').disabled) {
                    runInsertTest();
                }
            }

            // Ctrl/Cmd + Shift + Enter to run delete test (if admin)
            if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'Enter') {
                event.preventDefault();
                if (userRole === 'ADMIN' && !document.getElementById('deleteBtn').disabled) {
                    runDeleteTest();
                }
            }
        });

        // ===== ERROR RECOVERY =====

        window.addEventListener('error', function (event) {
            console.error('JavaScript error:', event.error);
            showNotification('An unexpected error occurred. Please refresh the page if problems persist.', 'error');
        });

        window.addEventListener('unhandledrejection', function (event) {
            console.error('Unhandled promise rejection:', event.reason);
            showNotification('A network or processing error occurred. Please try again.', 'error');
        });

        // ===== FINAL INITIALIZATION =====

        document.addEventListener('DOMContentLoaded', function () {
            console.log('🎯 Database Batch Performance Analyzer v2.0.0 initialized');
            console.log('✅ Authentication system active');
            console.log('✅ Rate limiting monitoring active');
            console.log('✅ Enhanced error handling active');
            console.log('✅ Responsive design active');
            console.log('✅ Accessibility features active');

            // Show a subtle welcome message
            setTimeout(() => {
                if (!currentUser) {
                    showNotification('Welcome! Please sign in to start performance testing.', 'info');
                }
            }, 1000);
        });

    </script>
</body>

</html>
