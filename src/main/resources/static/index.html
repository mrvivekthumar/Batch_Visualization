<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Batch Performance Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .control-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        input,
        select,
        button {
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .results-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .results-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .result-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .success {
            color: #28a745;
            font-weight: 600;
        }

        .error {
            color: #dc3545;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Database Batch Performance Analyzer</h1>
            <p>Real-time Performance Testing & Visualization Dashboard</p>
        </div>

        <!-- System Stats -->
        <div class="stats-grid" id="systemStats">
            <div class="stat-card">
                <div class="stat-value" id="cpuCount">-</div>
                <div class="stat-label">CPU Cores</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalMemory">-</div>
                <div class="stat-label">Total Memory (MB)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="usedMemory">-</div>
                <div class="stat-label">Used Memory (MB)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="dbRecords">-</div>
                <div class="stat-label">Database Records</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label for="totalRecords">Total Records</label>
                    <input type="number" id="totalRecords" value="1000" min="100" max="100000">
                </div>
                <div class="control-group">
                    <label for="batchSize">Batch Size</label>
                    <select id="batchSize">
                        <option value="1">1 (One by One)</option>
                        <option value="10">10</option>
                        <option value="100" selected>100</option>
                        <option value="1000">1000</option>
                        <option value="5000">5000</option>
                    </select>
                </div>
                <button onclick="runInsertTest()">üìù INSERT Test</button>
                <button onclick="runDeleteTest()">üóëÔ∏è DELETE Test</button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            Running performance test... Please wait.
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">‚è±Ô∏è Execution Time Comparison</div>
                <canvas id="timeChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">üìä Records Per Second</div>
                <canvas id="throughputChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">üíæ Memory Usage</div>
                <canvas id="memoryChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">üîÑ Average Time Per Record</div>
                <canvas id="avgTimeChart"></canvas>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <div class="results-title">üìà Test Results</div>
            <div id="resultsContainer">
                <p style="text-align: center; color: #666; font-style: italic;">
                    Run a performance test to see detailed results here.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let charts = {};
        let testResults = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            initializeCharts();
            loadSystemStats();
            loadDatabaseStats();

            // Auto-refresh stats every 30 seconds
            setInterval(() => {
                loadSystemStats();
                loadDatabaseStats();
            }, 30000);
        });



        // Run batch insertion test
        async function runInsertionTest() {
            const totalRecords = document.getElementById('totalRecords').value;
            const batchSize = document.getElementById('batchSize').value;
            showLoading();

            try {
                const response = await axios.post(`/api/performance/test/batch-insertion?totalRecords=${totalRecords}&batchSize=${batchSize}`);
                const result = response.data;

                testResults.push(result);
                updateCharts();
                displayResults([result]);
                loadDatabaseStats(); // Refresh database count
                showMessage(`‚úÖ Batch insertion test completed: ${result.recordsProcessed} records in ${result.durationMs}ms`, 'success');
            } catch (error) {
                showMessage('‚ùå Batch insertion test failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Initialize all charts
        function initializeCharts() {
            const chartConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            };

            // Time comparison chart
            charts.timeChart = new Chart(document.getElementById('timeChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Execution Time (ms)',
                        data: [],
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Time (milliseconds)'
                            }
                        }
                    }
                }
            });

            // Throughput chart
            charts.throughputChart = new Chart(document.getElementById('throughputChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Records/Second',
                        data: [],
                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 3,
                        fill: true
                    }]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Records per Second'
                            }
                        }
                    }
                }
            });

            // Memory usage chart
            charts.memoryChart = new Chart(document.getElementById('memoryChart'), {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: chartConfig
            });

            // Average time per record chart
            charts.avgTimeChart = new Chart(document.getElementById('avgTimeChart'), {
                type: 'radar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Avg Time/Record (ms)',
                        data: [],
                        backgroundColor: 'rgba(118, 75, 162, 0.2)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(118, 75, 162, 1)'
                    }]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        r: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Load system statistics
        async function loadSystemStats() {
            try {
                const response = await axios.get('/api/performance/stats/system');
                const stats = response.data;

                document.getElementById('cpuCount').textContent = stats.availableProcessors;
                document.getElementById('totalMemory').textContent = stats.totalMemoryMB;
                document.getElementById('usedMemory').textContent = stats.usedMemoryMB;
            } catch (error) {
                console.error('Failed to load system stats:', error);
            }
        }

        // Load database statistics
        async function loadDatabaseStats() {
            try {
                const response = await axios.get('/api/performance/stats/database');
                const stats = response.data;
                document.getElementById('dbRecords').textContent = stats.totalRecords;
            } catch (error) {
                console.error('Failed to load database stats:', error);
                document.getElementById('dbRecords').textContent = '0';
            }
        }

        // Show loading indicator
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.querySelectorAll('button').forEach(btn => btn.disabled = true);
        }

        // Hide loading indicator
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.querySelectorAll('button').forEach(btn => btn.disabled = false);
        }

        // Initialize test data
        async function initializeData() {
            const totalRecords = document.getElementById('totalRecords').value;
            showLoading();

            try {
                const response = await axios.post(`/api/performance/initialize?totalRecords=${totalRecords}`);

                if (response.data.status === 'success') {
                    showMessage(`‚úÖ Successfully initialized ${response.data.recordsCreated} records in ${response.data.initializationTimeMs}ms`, 'success');
                    loadDatabaseStats();
                } else {
                    showMessage('‚ùå Failed to initialize data', 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error initializing data: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Run single deletion test
        async function runSingleTest() {
            const records = Math.min(1000, document.getElementById('totalRecords').value / 10);
            showLoading();

            try {
                const response = await axios.post(`/api/performance/test/single-deletion?numberOfRecords=${records}`);
                const result = response.data;

                testResults.push(result);
                updateCharts();
                displayResults([result]);
                showMessage(`‚úÖ Single deletion test completed: ${result.recordsProcessed} records in ${result.durationMs}ms`, 'success');
            } catch (error) {
                showMessage('‚ùå Single deletion test failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Run batch deletion test
        async function runBatchTest() {
            const totalRecords = Math.min(5000, document.getElementById('totalRecords').value / 5);
            const batchSize = document.getElementById('batchSize').value;
            showLoading();

            try {
                const response = await axios.post(`/api/performance/test/batch-deletion?totalRecords=${totalRecords}&batchSize=${batchSize}`);
                const result = response.data;

                testResults.push(result);
                updateCharts();
                displayResults([result]);
                showMessage(`‚úÖ Batch deletion test completed: ${result.recordsProcessed} records in ${result.durationMs}ms`, 'success');
            } catch (error) {
                showMessage('‚ùå Batch deletion test failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Run comprehensive test
        async function runComprehensiveTest() {
            const totalRecords = document.getElementById('totalRecords').value;
            showLoading();

            try {
                const response = await axios.post(`/api/performance/test/comprehensive?totalRecords=${totalRecords}`);
                const data = response.data;

                if (data.status === 'success') {
                    testResults = testResults.concat(data.testResults);
                    updateCharts();
                    displayResults(data.testResults, data.summary);
                    showMessage(`‚úÖ Comprehensive test completed with ${data.testResults.length} different batch sizes`, 'success');
                } else {
                    showMessage('‚ùå Comprehensive test failed', 'error');
                }
            } catch (error) {
                showMessage('‚ùå Comprehensive test failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Update all charts with latest data
        function updateCharts() {
            if (testResults.length === 0) return;

            // Time comparison chart
            charts.timeChart.data.labels = testResults.map(r => `${r.testType} (${r.batchSize})`);
            charts.timeChart.data.datasets[0].data = testResults.map(r => r.durationMs);
            charts.timeChart.update('active');

            // Throughput chart
            charts.throughputChart.data.labels = testResults.map(r => `Batch ${r.batchSize}`);
            charts.throughputChart.data.datasets[0].data = testResults.map(r => r.recordsPerSecond);
            charts.throughputChart.update('active');

            // Memory chart
            const memoryData = testResults.slice(-5).map(r => r.memoryUsedMB);
            const memoryLabels = testResults.slice(-5).map(r => `Batch ${r.batchSize}`);
            charts.memoryChart.data.labels = memoryLabels;
            charts.memoryChart.data.datasets[0].data = memoryData;
            charts.memoryChart.update('active');

            // Average time chart
            charts.avgTimeChart.data.labels = testResults.map(r => `Batch ${r.batchSize}`);
            charts.avgTimeChart.data.datasets[0].data = testResults.map(r => r.averageTimePerRecord);
            charts.avgTimeChart.update('active');
        }

        // Display test results
        function displayResults(results, summary = null) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            if (summary) {
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'result-item';
                summaryDiv.innerHTML = `
                    <h4>üìä Performance Summary</h4>
                    <p><strong>Fastest:</strong> ${summary.fastestTest?.testType} with batch size ${summary.fastestTest?.batchSize} - ${summary.fastestTest?.averageTimePerRecord?.toFixed(3)}ms per record</p>
                    <p><strong>Highest Throughput:</strong> ${summary.highestThroughputTest?.recordsPerSecond?.toFixed(0)} records/second</p>
                    <p><strong>Performance Improvement:</strong> ${summary.performanceImprovementPercentage}% faster than slowest method</p>
                `;
                container.appendChild(summaryDiv);
            }

            results.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-item';
                resultDiv.innerHTML = `
                    <h4>${result.testType.replace('_', ' ')} - Batch Size: ${result.batchSize}</h4>
                    <p><strong>Records Processed:</strong> ${result.recordsProcessed}</p>
                    <p><strong>Duration:</strong> ${result.durationMs}ms</p>
                    <p><strong>Avg Time/Record:</strong> ${result.averageTimePerRecord.toFixed(3)}ms</p>
                    <p><strong>Throughput:</strong> ${result.recordsPerSecond.toFixed(0)} records/second</p>
                    <p><strong>Memory Used:</strong> ${result.memoryUsedMB}MB</p>
                `;
                container.appendChild(resultDiv);
            });
        }



        // Run insert test with selected batch size
        async function runInsertTest() {
            const totalRecords = document.getElementById('totalRecords').value;
            const batchSize = document.getElementById('batchSize').value;
            showLoading();

            try {
                const response = await axios.post(`/api/performance/initialize?totalRecords=${totalRecords}&batchSize=${batchSize}`);
                const result = response.data;

                testResults.push(result);
                updateCharts();
                displayResults([result]);
                loadDatabaseStats();

                const operation = batchSize == 1 ? "one by one" : `in batches of ${batchSize}`;
                showMessage(`‚úÖ INSERT completed: ${result.recordsProcessed} records ${operation} in ${result.durationMs}ms`, 'success');
            } catch (error) {
                showMessage('‚ùå INSERT test failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Run delete test with selected batch size
        async function runDeleteTest() {
            const totalRecords = document.getElementById('totalRecords').value;
            const batchSize = document.getElementById('batchSize').value;
            showLoading();

            try {
                const response = await axios.post(`/api/performance/delete?totalRecords=${totalRecords}&batchSize=${batchSize}`);
                const result = response.data;

                testResults.push(result);
                updateCharts();
                displayResults([result]);
                loadDatabaseStats();

                const operation = batchSize == 1 ? "one by one" : `in batches of ${batchSize}`;
                showMessage(`‚úÖ DELETE completed: ${result.recordsProcessed} records ${operation} in ${result.durationMs}ms`, 'success');
            } catch (error) {
                showMessage('‚ùå DELETE test failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Show message
        function showMessage(message, type) {
            // Create or update message element
            let messageEl = document.getElementById('messageDisplay');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'messageDisplay';
                messageEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 10px;
                    color: white;
                    font-weight: 600;
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                `;
                document.body.appendChild(messageEl);
            }

            messageEl.textContent = message;
            messageEl.style.backgroundColor = type === 'success' ? '#28a745' : '#dc3545';
            messageEl.style.display = 'block';

            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
    </script>

    <style>
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        canvas {
            height: 300px !important;
        }
    </style>
</body>

</html>